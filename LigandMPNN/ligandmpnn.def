Bootstrap: docker
#Bootstrap: docker-daemon
From: nvidia/cuda:12.2.2-cudnn8-devel-ubuntu22.04

%post
    # 设置环境变量
    export DEBIAN_FRONTEND=noninteractive
    export TZ=Etc/UTC
    
    # 更新系统并安装基础软件
    apt-get update && apt-get install -y \
        wget \
        curl \
        git \
        build-essential \
        software-properties-common \
        libssl-dev \
        zlib1g-dev \
        libbz2-dev \
        libreadline-dev \
        libsqlite3-dev \
        libncursesw5-dev \
        libgdbm-dev \
        libc6-dev \
        libffi-dev \
        liblzma-dev \
        ca-certificates \
        bash \
        && rm -rf /var/lib/apt/lists/*

    # 安装 Python 3.11
    apt-get update && apt-get install -y \
        python3.11 \
        python3.11-dev \
        python3.11-distutils \
        python3.11-venv \
        python3-pip

    # 设置 Python 3.11 为默认 python3
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1
    update-alternatives --set python3 /usr/bin/python3.11

    # 升级 pip
    pip3 config set global.index-url https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple
    python3 -m pip install --upgrade pip

    # 创建应用目录
    mkdir -p /app

    # 克隆 LigandMPNN 仓库
    cd /app
    git clone https://github.com/dauparas/LigandMPNN.git

    # 进入 LigandMPNN 目录并运行命令
    cd /app/LigandMPNN
    
    # 运行 get_model_params.sh
    bash get_model_params.sh "./model_params"
    
    # 安装 Python 依赖
    pip3 install -r requirements.txt

    # 清理缓存
    python3 -m pip cache purge
    apt-get clean

%environment
    export PATH=/usr/local/bin:$PATH
    export PYTHONPATH=/app/LigandMPNN:$PYTHONPATH
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    

%labels
    Author Mo Qiqin
    Version 1.0.0
    Description "Singularity container for LigandMPNN with CUDA 12.2.2 and Python 3.11"

%help
    这是一个用于运行 LigandMPNN 的 Singularity 容器。
    基于 nvidia/cuda:12.2.2-cudnn8-devel-ubuntu22.04 镜像构建。
    包含：
    - Python 3.11
    - CUDA 12.2.2
    - cuDNN 8
    - LigandMPNN 及其依赖
    
    使用方法：
    1. 构建镜像：sudo singularity build ligandmpnn.sif ligandmpnn.def
    2. 运行容器：singularity run ligandmpnn.sif
    3. 进入交互模式：singularity shell ligandmpnn.sif
